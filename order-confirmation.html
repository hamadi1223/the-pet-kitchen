<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Confirmation - The Pet Kitchen</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23ffffff'/><text x='50' y='70' font-size='60' text-anchor='middle'>üêæ</text></svg>">
  <style>
    .confirmation-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .confirmation-header {
      text-align: center;
      padding: 2rem 0;
      border-bottom: 2px solid #E9DECE;
      margin-bottom: 2rem;
    }
    .success-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    .confirmation-badge {
      display: inline-block;
      background: rgba(27, 138, 90, 0.1);
      color: #1B8A5A;
      padding: 0.5rem 1.5rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .test-mode-badge {
      display: inline-block;
      background: #FEF3C7;
      color: #92400E;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .order-summary {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .order-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .info-item {
      display: flex;
      flex-direction: column;
    }
    .info-label {
      font-size: 0.85rem;
      color: var(--ink-600);
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .info-value {
      font-size: 1.1rem;
      color: var(--ink-900);
      font-weight: 600;
    }
    .order-items {
      margin-top: 2rem;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: start;
      padding: 1.5rem;
      border-bottom: 1px solid #E9DECE;
    }
    .order-item:last-child {
      border-bottom: none;
    }
    .item-details {
      flex: 1;
    }
    .item-name {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--ink-900);
      margin-bottom: 0.5rem;
    }
    .item-meta {
      font-size: 0.9rem;
      color: var(--ink-600);
      margin-top: 0.25rem;
    }
    .item-price {
      text-align: right;
    }
    .item-quantity {
      font-size: 0.9rem;
      color: var(--ink-600);
      margin-bottom: 0.5rem;
    }
    .item-total {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--ink-900);
    }
    .order-totals {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #E9DECE;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      font-size: 1.1rem;
    }
    .total-row.final {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--ink-900);
      border-top: 1px solid #E9DECE;
      padding-top: 1rem;
      margin-top: 0.5rem;
    }
    .action-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    .loading-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .error-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #DC2626;
    }
    .pet-info {
      background: #FAF8F5;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    @media (max-width: 768px) {
      .order-item {
        flex-direction: column;
      }
      .item-price {
        text-align: left;
        margin-top: 1rem;
      }
      .order-info-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">
          <span>THE PET KITCHEN</span>
        </a>
        <nav class="nav desktop-nav" role="navigation">
          <ul class="nav-list">
            <li><a href="index.html" class="nav-link">HOME</a></li>
            <li><a href="account.html" class="nav-link">ACCOUNT</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main class="confirmation-container">
    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
      <div class="success-icon">‚è≥</div>
      <h2>Loading order details...</h2>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-state" style="display: none;">
      <h2>Error Loading Order</h2>
      <p id="errorMessage"></p>
      <div class="action-buttons">
        <a href="account.html" class="btn btn-primary">View My Orders</a>
        <a href="index.html" class="btn btn-outline">Back to Home</a>
      </div>
    </div>

    <!-- Confirmation Content -->
    <div id="confirmationContent" style="display: none;">
      <div class="confirmation-header">
        <div class="success-icon">‚úÖ</div>
        <div class="confirmation-badge" id="orderStatusBadge">ORDER CONFIRMED</div>
        <h1>Thank You for Your Order!</h1>
        <p style="color: var(--ink-700); margin-top: 0.5rem;">
          Your order has been received and is being processed.
        </p>
        <div id="testModeBadge" class="test-mode-badge" style="display: none;">
          üß™ TEST MODE - Payment Simulation
        </div>
      </div>

      <div class="order-summary">
        <div class="order-info-grid">
          <div class="info-item">
            <span class="info-label">Order Number</span>
            <span class="info-value" id="orderNumber">#0000</span>
          </div>
          <div class="info-item">
            <span class="info-label">Order Date</span>
            <span class="info-value" id="orderDate">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Payment Status</span>
            <span class="info-value" id="paymentStatus">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">Total Amount</span>
            <span class="info-value" id="totalAmount">0.000 KD</span>
          </div>
        </div>

        <div class="order-items">
          <h3 style="margin-bottom: 1rem; color: var(--ink-900);">Order Items</h3>
          <div id="orderItemsList">
            <!-- Order items will be inserted here -->
          </div>
        </div>

        <div class="order-totals">
          <div class="total-row">
            <span>Subtotal</span>
            <span id="subtotal">0.000 KD</span>
          </div>
          <div class="total-row">
            <span>Shipping</span>
            <span>Free</span>
          </div>
          <div class="total-row final">
            <span>Total</span>
            <span id="finalTotal">0.000 KD</span>
          </div>
        </div>

        <div id="petInfoSection" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #E9DECE;">
          <h3 style="margin-bottom: 1rem; color: var(--ink-900);">Pet Information</h3>
          <div id="petInfo" class="pet-info"></div>
        </div>
      </div>

      <div class="action-buttons">
        <a href="account.html" class="btn btn-primary">View My Orders</a>
        <a href="index.html" class="btn btn-outline">Continue Shopping</a>
      </div>

      <div style="margin-top: 3rem; padding: 2rem; background: #FAF8F5; border-radius: 12px; text-align: center;">
        <h3 style="margin-bottom: 1rem; color: var(--ink-900);">What's Next?</h3>
        <p style="color: var(--ink-700); line-height: 1.6;">
          You will receive an email confirmation shortly. Our team will prepare your order and contact you for delivery details.
          <br><br>
          <strong>Need help?</strong> Contact us at <a href="mailto:info@thepetkitchen.net" style="color: var(--accent);">info@thepetkitchen.net</a>
        </p>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>THE PET KITCHEN</h4>
          <p>Fresh, premium pet food delivered to your door.</p>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/security.js"></script>
  <script src="js/api.js"></script>
  <script src="js/email-service.js"></script>
  <script src="js/app.js"></script>
  <script>
    // Order Confirmation Page
    (async function() {
      // Wait for DOM and API to be ready
      if (document.readyState === 'loading') {
        await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
      }
      
      // Wait for API to be available
      let retries = 0;
      while (!window.ordersAPI && retries < 20) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }
      
      if (!window.ordersAPI) {
        console.error('‚ùå Orders API not available after waiting');
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'API not loaded. Please refresh the page.';
        return;
      }
      
      await loadOrderConfirmation();
    })();
    
    async function loadOrderConfirmation() {
      const loadingState = document.getElementById('loadingState');
      const errorState = document.getElementById('errorState');
      const confirmationContent = document.getElementById('confirmationContent');
      const errorMessage = document.getElementById('errorMessage');

      // Get order ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get('orderId') || urlParams.get('order_id');
      const isTestMode = urlParams.get('test') === 'true' || window.location.pathname.includes('test');

      if (isTestMode) {
        document.getElementById('testModeBadge').style.display = 'inline-block';
      }

      if (!orderId) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        errorMessage.textContent = 'No order ID provided. Please check your order confirmation link.';
        return;
      }

      // Check if user is logged in
      if (!window.getToken || !window.getToken()) {
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        errorMessage.textContent = 'Please log in to view your order details.';
        return;
      }

      try {
        console.log('üì¶ [CONFIRMATION] Loading order:', orderId);
        console.log('üì¶ [CONFIRMATION] API available:', !!window.ordersAPI);
        console.log('üì¶ [CONFIRMATION] Token available:', !!window.getToken());
        console.log('üì¶ [CONFIRMATION] API Base URL:', window.API_BASE_URL);
        
        // Fetch order details
        console.log('üì¶ [CONFIRMATION] Fetching order from API...');
        const order = await window.ordersAPI.getOne(orderId);
        console.log('üì¶ [CONFIRMATION] Order received:', order);

        if (!order || !order.id) {
          throw new Error('Order not found');
        }

        // Render order details
        renderOrderDetails(order);

        loadingState.style.display = 'none';
        confirmationContent.style.display = 'block';

        // Send confirmation emails if order is paid (only once)
        if (order.status === 'paid' && !sessionStorage.getItem(`email_sent_${order.id}`)) {
          sendOrderEmails(order);
          sessionStorage.setItem(`email_sent_${order.id}`, 'true');
        }
      } catch (error) {
        console.error('‚ùå [CONFIRMATION] Error loading order:', error);
        console.error('‚ùå [CONFIRMATION] Error details:', {
          message: error.message,
          stack: error.stack,
          orderId: orderId,
          hasOrdersAPI: !!window.ordersAPI,
          ordersAPIMethods: window.ordersAPI ? Object.keys(window.ordersAPI) : 'N/A',
          token: window.getToken() ? 'Present' : 'Missing',
          apiBaseUrl: window.API_BASE_URL
        });
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        
        // Provide more helpful error messages
        let errorMsg = error.message || 'Failed to load order details.';
        if (error.message && error.message.includes('401')) {
          errorMsg = 'Please log in to view your order details.';
        } else if (error.message && error.message.includes('404')) {
          errorMsg = 'Order not found. Please check your order ID.';
        } else if (error.message && error.message.includes('Failed to fetch')) {
          errorMsg = 'Cannot connect to server. Please check your connection.';
        }
        
        errorMessage.textContent = errorMsg;
      }
    }

    function renderOrderDetails(order) {
      console.log('üì¶ [CONFIRMATION] Rendering order details:', order);
      
      // Order info
      document.getElementById('orderNumber').textContent = `#${order.id}`;
      
      const orderDate = new Date(order.created_at);
      document.getElementById('orderDate').textContent = orderDate.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Status
      const status = order.status || 'created';
      const statusBadge = document.getElementById('orderStatusBadge');
      statusBadge.textContent = status.toUpperCase();
      if (status === 'paid' || status === 'fulfilled') {
        statusBadge.style.background = 'rgba(27, 138, 90, 0.1)';
        statusBadge.style.color = '#1B8A5A';
      } else if (status === 'failed' || status === 'cancelled') {
        statusBadge.style.background = 'rgba(220, 38, 38, 0.1)';
        statusBadge.style.color = '#DC2626';
      }

      document.getElementById('paymentStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);

      // Total
      const total = parseFloat(order.total_amount || 0);
      document.getElementById('totalAmount').textContent = `${total.toFixed(3)} KD`;
      document.getElementById('subtotal').textContent = `${total.toFixed(3)} KD`;
      document.getElementById('finalTotal').textContent = `${total.toFixed(3)} KD`;

      // Order items
      const itemsList = document.getElementById('orderItemsList');
      if (order.items && order.items.length > 0) {
        itemsList.innerHTML = order.items.map(item => {
          const itemTotal = parseFloat(item.unit_price || 0) * item.quantity;
          let metaInfo = '';
          
          // Parse metadata for subscriptions
          if (item.meta) {
            try {
              const meta = typeof item.meta === 'string' ? JSON.parse(item.meta) : item.meta;
              if (meta.type === 'subscription') {
                metaInfo = `
                  <div class="item-meta">
                    ${meta.plan_type ? `Plan: ${meta.plan_type.charAt(0).toUpperCase() + meta.plan_type.slice(1)}` : ''}
                    ${meta.total_pouches ? ` ‚Ä¢ ${meta.total_pouches} pouches` : ''}
                    ${meta.daily_grams ? ` ‚Ä¢ ${meta.daily_grams}g/day` : ''}
                  </div>
                `;
              }
            } catch (e) {
              // Meta parsing failed
            }
          }

          return `
            <div class="order-item">
              <div class="item-details">
                <div class="item-name">${escapeHtml(item.product_name || 'Product')}</div>
                ${item.sku ? `<div class="item-meta">SKU: ${escapeHtml(item.sku)}</div>` : ''}
                ${metaInfo}
              </div>
              <div class="item-price">
                <div class="item-quantity">Quantity: ${item.quantity}</div>
                <div class="item-total">${itemTotal.toFixed(3)} KD</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        itemsList.innerHTML = '<p style="color: var(--ink-600);">No items found.</p>';
      }

      // Pet info
      if (order.pet_name) {
        const petSection = document.getElementById('petInfoSection');
        const petInfo = document.getElementById('petInfo');
        petSection.style.display = 'block';
        petInfo.innerHTML = `
          <strong>${escapeHtml(order.pet_name)}</strong>
          ${order.pet_type ? ` ‚Ä¢ ${order.pet_type.charAt(0).toUpperCase() + order.pet_type.slice(1)}` : ''}
          ${order.breed ? ` ‚Ä¢ ${escapeHtml(order.breed)}` : ''}
          ${order.weight_kg ? ` ‚Ä¢ ${order.weight_kg} kg` : ''}
        `;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Send order confirmation emails
     */
    async function sendOrderEmails(order) {
      if (!window.sendOrderConfirmationEmail || !window.sendNewOrderNotificationEmail) {
        console.warn('‚ö†Ô∏è Email service not loaded');
        return;
      }

      try {
        // Get current user for email
        const user = window.getCurrentUser ? window.getCurrentUser() : null;
        
        // Prepare order data for customer email
        const customerOrderData = {
          customer_name: user?.name || 'Valued Customer',
          customer_email: user?.email || order.email || '',
          customer_phone: user?.phone || order.phone || '',
          order_number: order.id,
          order_date: new Date(order.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          }),
          order_time: new Date(order.created_at).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
          }),
          items: order.items || [],
          total: parseFloat(order.total_amount || 0),
          status: order.status,
          invoice_id: order.payment_invoice_id || order.payment_reference || '',
          payment_method: 'MyFatoorah',
          delivery_address: order.delivery_address || ''
        };

        // Send customer confirmation email
        const customerEmailResult = await window.sendOrderConfirmationEmail(customerOrderData);
        if (customerEmailResult.success) {
          console.log('‚úÖ Order confirmation email sent to customer');
        } else {
          console.warn('‚ö†Ô∏è Failed to send customer email:', customerEmailResult.error);
        }

        // Prepare order data for owner notification
        const ownerOrderData = {
          ...customerOrderData,
          customer_phone: user?.phone || order.phone || 'N/A'
        };

        // Send owner notification email
        const ownerEmailResult = await window.sendNewOrderNotificationEmail(ownerOrderData);
        if (ownerEmailResult.success) {
          console.log('‚úÖ New order notification email sent to owner');
        } else {
          console.warn('‚ö†Ô∏è Failed to send owner email:', ownerEmailResult.error);
        }

      } catch (error) {
        console.error('‚ùå Error sending order emails:', error);
      }
    }
  </script>
</body>
</html>
